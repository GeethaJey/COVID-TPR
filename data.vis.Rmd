---
title: "Data Visualization"
author: "Geetha"
date: "23/08/2020"
output: github_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
                     
library(ggplot2)
library(dplyr)
library(countrycode)
library(gsheet)
library(tidyr)
library(readxl)
library(stringr)
library(GGally)

```

```{r dataset, include=FALSE, warning=FALSE}
#GLOBAL DATASETS
#####################
#Our World in Data
owid <- read.csv("https://covid.ourworldindata.org/data/owid-covid-data.csv")

owid <- (owid %>% 
        mutate(location = as.factor(location), continent = as.factor(continent), iso_code = as.factor(iso_code), date = (as.Date(date, format= "%Y-%m-%d")),tests_units = as.factor(tests_units)) %>% 
        mutate(cumulative.tpr = (total_cases/total_tests)*100, daily.tpr = (new_cases/new_tests)*100) %>% 
        filter(!is.na(daily.tpr)) %>% 
        select (!(total_cases:stringency_index)) %>%  
        rename(country = location, ISO = iso_code))
        

#DELVE (Data Evaluation and Learning for Viral Epidemics) Dataset 
delve = read.csv(url("https://raw.githubusercontent.com/rs-delve/covid19_datasets/master/dataset/combined_dataset_latest.csv"))
delve <- (delve %>%
            mutate(DATE = as.Date(DATE, format= "%Y-%m-%d"), country_name = as.factor(country_name), ISO = as.factor(ISO)) %>%
            mutate(across(c(starts_with("npi") & !(npi_fiscal_measures|npi_international_support|npi_healthcare_investment|npi_vaccine_investment|npi_stringency_index)), as.factor)) %>% 
            rename (date = DATE, country = country_name))
          


#Country Effective Reproductive Number Estimates from University of Oxford, Australian National University, and Harvard from http://epidemicforecasting.org/
Rt <- read.csv("https://storage.googleapis.com/static-covid/static/v4/main/r_estimates.csv")
Rtcountry <- (Rt %>%
                      mutate(Date = as.Date(Date, format= "%Y-%m-%d"), X = NULL) %>%
                      filter(!grepl ("^US-", Code), !grepl ("^AU-", Code), !grepl ("^CN-", Code)) %>% 
                      mutate(country = countrycode(Code, "iso2c","country.name"), country =as.factor(country)) %>% #converting country codes to country names. States not converted 
                      rename(date=Date))

#Open Data Barometer (Openness of data measurement)
odb <- read.csv("https://opendatabarometer.org/assets/data/ODB-2014-Rankings.csv")
odb <- odb %>% select (ISO3:ODB.Scaled) %>% rename(country = Country, ISO = ISO3)

#global health security index (from https://www.ghsindex.org/wp-content/uploads/2019/10/Global-Health-Security-Index-2019-Final-October-2019.zip) *will update with better link once .xlsm data import figured out
ghsrange <- "N4:OP267"
ghslast <- 197
# importing the iScores sheet of the xlsm file,
GHSI <- read_excel("ghsindex.xlsm",sheet = "iScores", range = ghsrange,col_names = TRUE) 
GHSI <- t(GHSI)
#making the first row the column names
ghscoltitle <- GHSI[1,] 
colnames(GHSI, do.NULL = TRUE, prefix = "col" )
colnames(GHSI) <- ghscoltitle
#turn excel matrix into data frame
GHSI <- as.data.frame(GHSI)
names(GHSI) <- (names(GHSI) %>% str_replace_all("\\s","_"))
GHSI <- (GHSI %>%
                 rename(country = Indicators) %>% 
                 rename( '1)Prevent' = `1)_PREVENTION_OF_THE_EMERGENCE_OR_RELEASE_OF_PATHOGENS`, '2)Detect' = `2)_EARLY_DETECTION_&_REPORTING_EPIDEMICS_OF_POTENTIAL_INTERNATIONAL_CONCERN`, '3)Response' = `3)_RAPID_RESPONSE_TO_AND_MITIGATION_OF_THE_SPREAD_OF_AN_EPIDEMIC`,'4)Health' = `4)_SUFFICIENT_&_ROBUST_HEALTH_SECTOR_TO_TREAT_THE_SICK_&_PROTECT_HEALTH_WORKERS`,'5)Norms' = `5)_COMMITMENTS_TO_IMPROVING_NATIONAL_CAPACITY,_FINANCING_AND_ADHERENCE_TO_NORMS`, '6)Risk' = `6)_OVERALL_RISK_ENVIRONMENT_AND_COUNTRY_VULNERABILITY_TO_BIOLOGICAL_THREATS`) %>% 
                 slice(2:ghslast) %>% 
                 mutate_at(vars(-country), as.numeric))

# Putting together global Dataset
global <- full_join(owid, delve, by = c("country", "date"))
global <- full_join(global,Rtcountry, by = c("country", "date")) 
global <- full_join (global, odb, by = "country", "ISO")
global <- full_join(global, GHSI, by = "country")

global <- (global %>% 
                   mutate(ISO = as.factor(ISO), country = as.factor(country)))
```

```{r reduced, echo=FALSE}
#Filtered Dataset
OECD <- c("United States", "Mexico", "Japan", "Turkey", "Germany", "United Kingdom", "France", "Italy", "South Korea","Spain", "Poland", "Canada", "Australia", "Chile", "Netherlands", "Belgium", "Czech Republic", "Greece", "Portugal", "Sweden", "Hungary", "Austria", "Israel", "Switzerland", "Denmark", "Finland", "Slovakia", "Norway", "Ireland"," New Zealand", "Lithuania", "Slovenia", "Latvia","Estonia", "Luxembourg", "Iceland")
reduced <- (global %>%  filter(country == OECD))
```

## Overview of Global Performance 
South Korea, Vietnam, Germany and New Zealand have been highlighted by [Exemplars in Global Health](https://www.exemplars.health/emerging-topics/epidemic-preparedness-and-response/covid-19) as countries that are doing comparatively well in managing their outbreak. Mexico, India, Indonesia, and Argentina are examples of countries that have not yet "bent the curve", many with quite high test positivity rates. 

#### Metrics

* Test positivity rate: daily TPR, cumulative TPR
* Number of Deaths (daily, cumulative, per million, per thousand, smoothed over 7 days)
* Number of cases (daily, cumulative per million, per thousand, smoothed over 7 days)
* Number of tests (raw,per million, per thousand, smoothed over 7 days) 

Potential Independent variables: 

* Non-pharmaceutical interventions: closings, masks, lockdown, debt relief, etc. 
* GHS index: overall score, category scores, sub-indicator scores
* Country characteristics: population, pop density, median age, % pop > 65 y/0, % pop > 70 y/o, GDP
* Disease burden: cardiovascular disease, diabetes, smoking,  life expectancy
* Weather: temp, wind, humidity, precipitation


Potential Options for Inclusion/Exclusion Criteria: 

* remove countries with > 100 number of confirmed cases (some papers have used 1000)
* remove countries with  population >1,000,000 
* only use OECD countries (this is what is currently used for the graphs below)
* only WHO member states 
* completeness of dataset (must have test data for X% of sample period)

# Metrics Over Time

### Testing

#### Number of Tests
```{r}
newtests <- ggplot(reduced, aes(x = date, y = tests_new_per_thousand, group=country)) + 
  geom_line(aes(color=country)) + xlab("Date") + 
  ylab("New Tests Per Thousand") +
  ggtitle("New Tests (per thousand people) over Time") + 
  labs(color="Country") +
  theme(plot.title = element_text(hjust = 0.5))
print(newtests)

```

#### Test Positivity Rates Over Time
```{r, warning=FALSE, echo=FALSE}
# Plot 1: Line graph to visualize/compare daily TPR over time
ctpr <- ggplot(reduced, aes(x = date, y = cumulative.tpr, group=country)) + 
  geom_line(aes(color=country)) + xlab("Date") + 
  ylab("Cumulative Test Positivity Rate (%)") +
  ggtitle("Cumulative TPR Over Time") + 
  labs(color="Country") +
  theme(plot.title = element_text(hjust = 0.5))
print(ctpr)
```

```{r}
dtpr <- ggplot(reduced, aes(x = date, y = daily.tpr, group=country)) + 
  geom_line(aes(color=country)) + xlab("Date") + 
  ylab("Daily Test Positivity Rate (%)") +
  ggtitle("Daily TPR Over Time") + 
  labs(color="Country") +
  theme(plot.title = element_text(hjust = 0.5))
print(dtpr)
```


#### Number of Cases
```{r}
newcases <- ggplot(reduced, aes(x = date, y = cases_new_per_million, group=country)) + 
  geom_line(aes(color=country)) + xlab("Date") + 
  ylab("New Cases Per Million") +
  ggtitle("Number of New Cases per Million People") + 
  labs(color="Country") +
  theme(plot.title = element_text(hjust = 0.5))
print(newcases)
```

#### Number of Deaths
```{r}
newdeaths <- ggplot(reduced, aes(x = date, y = deaths_new_per_million, group=country)) + 
  geom_line(aes(color=country)) + xlab("Date") + 
  ylab("New Deaths Per Million") +
  ggtitle("Number of New Deaths per Million People") + 
  labs(color="Country") +
  theme(plot.title = element_text(hjust = 0.5))
print(newdeaths)
```


## Non Pharmaceutical Interventions
##### Government Stringency Index
```{r NPI, echo=FALSE}
npi <- ggplot(reduced, aes(x= npi_stringency_index, y=cases_new_per_million, 
                      color=country))+ 
  geom_boxplot()+
  labs(col="Country")+
  xlab("NPI Stringency Index") + ylab("New Cases/Million People") + 
  ggtitle("New Cases and NPI Stringency Index") +
  theme(plot.title = element_text(hjust = 0.5))
print(npi)
```

### Interventions within Stringency Index
```{r}
npi_int <- ggparcoord(reduced, columns = c(22:29, 35, 36, 40),
                  groupColumn = "cases_new_per_million", scale="uniminmax", alphaLines=0.1) +
  xlab("NPI Category") + ylab("Value (scaled between 0 and 1") + 
  ggtitle("Effect of NPIs on New Cases/Million") +
  theme_minimal()+ theme(plot.title = element_text(hjust = 0.5)) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(npi_int)
```



### Masks
```{r gov index, echo=FALSE}
mask <- ggplot(reduced, aes(x=npi_stringency_index, y=cases_total_per_million))+ 
  geom_point()+
  geom_smooth(method=lm)+
  xlab("Government Stringency Index") + ylab("Total Cases Per Million") + 
  ggtitle("Government Stringency Index and Total Cases Per Million") +
  theme(plot.title = element_text(hjust = 0.5))
print(mask)

```


### Disease Burden
```{r}
# Disease burden factors and cTPR
db <- ggparcoord(reduced, columns = 12:15,
                  groupColumn = "cumulative.tpr", scale="uniminmax", alphaLines=0.1) +
  xlab("Disease burden") + ylab("Value") + ggtitle("Disease burden and cumulative TPR") +
  theme_minimal()+ theme(plot.title = element_text(hjust = 0.5)) + theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
print(db)
```

### Mask Policy 

```{r masks, echo=FALSE}
mask <- ggplot(reduced, aes(x=npi_masks, y=cumulative.tpr))+ 
  geom_boxplot()+
  xlab("Mask Policy") + ylab("Cumulative Test Positivity Rate") + 
  ggtitle("Mask Policy and Cumulative Test Positivity Rate") +
  theme(plot.title = element_text(hjust = 0.5))
print(mask)
```
#### Parallel Coordinate plot of different NPIs vs Cases
```{r, warning=FALSE, echo=FALSE}
npi <- ggparcoord(reduced, columns = c(22:29, 35, 36, 40),
                  groupColumn = "cases_total_per_million", scale="uniminmax", alphaLines=0.1) +
  xlab("NPI Category") + ylab("Value (scaled between 0 and 1") + 
  ggtitle("Effect of NPIs on Total Cases/Million") +
  theme_minimal()+ theme(plot.title = element_text(hjust = 0.5)) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(npi)
```

## Mobility Measures
```{r, warning=FALSE, echo=FALSE}
pcp <- ggparcoord(reduced, columns = 64:72,
                  groupColumn = "cases_total_per_million", scale="uniminmax", alphaLines=0.1) +
  xlab("mobility factors") + ylab("Value") + 
  ggtitle("Mobility factors and total cases per million people") +
  theme(plot.title = element_text(hjust = 0.5)) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
print(pcp)
```


## Global Health Security Index

### Overall GHSI score

### GHSI Categories
```{r ghs index}

# Plot 1: Line graph to visualize/compare daily TPR over time
ghs <- ggparcoord(reduced, columns = c(97, 154, 191, 234, 273, 312),
                  groupColumn = "cumulative.tpr", scale="uniminmax", alphaLines=0.1) +
  xlab("GHS Indicator") + ylab("Scaled Indicator Value") + ggtitle("Cumulative TPR versus GHS") +
  labs(col = c("1","2")) +
  theme_minimal()+ theme(plot.title = element_text(hjust = 0.5)) 
print(ghs)
```


## Weather Variables
#### Humidity
```{r}
# Humidity and total cases (upward trend)
hum <- ggplot(reduced, aes(x=weather_humidity_mean,y=cases_total_per_million))+ 
  geom_point(alpha=0.5) +
  geom_smooth(method = "lm") +
  xlab("Mean humidity") + ylab("Total cases/million people") + 
  ggtitle("Mean humidity and total cases/million people") +
  theme(plot.title = element_text(hjust = 0.5))
print(hum)
```
#### Temperature Speed
```{r}
temp <- ggplot(reduced, aes(x=weather_temperature_mean,y= cases_total_per_million))+ 
  geom_point(alpha=0.5) +
  geom_smooth(method = "lm") +
  xlab("Mean temperature") + ylab("Total cases/million people") + 
  ggtitle("Mean temperature and total cases/million people") +
  theme(plot.title = element_text(hjust = 0.5))
print(temp)
```
#### Wind Speed
```{r}
wind <- ggplot(reduced, aes(x=weather_wind_speed_mean, y= cases_total_per_million))+ 
  geom_point(alpha=0.5) +
  geom_smooth(method = "lm") +
  xlab("Mean wind speed") + ylab("Total cases/million people") + 
  ggtitle("Mean wind speed and total cases/million people") +
  theme(plot.title = element_text(hjust = 0.5))
print(wind)
```

